name: Approval Gatekeeper

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted, dismissed]

jobs:
  check-approvals:
    runs-on: ubuntu-latest
    steps:
      - name: Verify Approval Count
        uses: actions/github-script@v7
        with:
          script: |
            // 1. Get the PR number and Author Association
            const prNumber = context.payload.pull_request ? context.payload.pull_request.number : context.payload.issue.number;
            const { owner, repo } = context.repo;

            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            // Define who counts as a "Maintainer"
            // OWNER = Repo owner
            // MEMBER = Organization member
            // COLLABORATOR = Invited external collaborator with write access
            const maintainerRoles = ['OWNER', 'MEMBER', 'COLLABORATOR'];
            const authorRole = pr.data.author_association;
            
            console.log(`PR Author Role: ${authorRole}`);

            // 2. If Maintainer, pass immediately (relying on the native 1-approval rule)
            if (maintainerRoles.includes(authorRole)) {
              console.log("Author is a maintainer. Gatekeeper passed.");
              return;
            }

            // 3. If Non-Maintainer, count the approvals
            console.log("Author is a contributor. Enforcing 2 approvals.");
            
            const reviews = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number: prNumber,
            });

            // Filter to get the latest review state per user
            const latestReviews = {};
            reviews.data.forEach(review => {
              latestReviews[review.user.id] = review.state;
            });

            // Count how many users are currently 'APPROVED'
            const approvalCount = Object.values(latestReviews).filter(state => state === 'APPROVED').length;
            
            console.log(`Current Approval Count: ${approvalCount}`);

            // 4. Fail if count is less than 2
            if (approvalCount < 2) {
              core.setFailed(`External contributors require 2 approvals to merge. Current: ${approvalCount}`);
            } else {
              console.log("Approval requirement met.");
            }
